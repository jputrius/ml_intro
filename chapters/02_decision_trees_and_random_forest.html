<!DOCTYPE html>
<html lang="en"><head>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="02_decision_trees_and_random_forest_files/libs/clipboard/clipboard.min.js"></script>
<script src="02_decision_trees_and_random_forest_files/libs/quarto-html/tabby.min.js"></script>
<script src="02_decision_trees_and_random_forest_files/libs/quarto-html/popper.min.js"></script>
<script src="02_decision_trees_and_random_forest_files/libs/quarto-html/tippy.umd.min.js"></script>
<link href="02_decision_trees_and_random_forest_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="02_decision_trees_and_random_forest_files/libs/quarto-html/light-border.css" rel="stylesheet">
<link href="02_decision_trees_and_random_forest_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.8.24">

  <title>Decision Trees and Random Forest</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="02_decision_trees_and_random_forest_files/libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="02_decision_trees_and_random_forest_files/libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="02_decision_trees_and_random_forest_files/libs/revealjs/dist/theme/quarto-9df06d9b3e1683bd31835b8738a1bbfc.css">
  <link href="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>
  
  <script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Decision Trees and Random Forest</h1>

<div class="quarto-title-authors">
</div>

</section>
<section id="introduction" class="slide level2">
<h2>Introduction</h2>
<p>In this chapter we will cover Decision Trees and Random Forest.</p>
<p>However, we first need to quickly define entropy of a random variable.</p>
</section>
<section id="entropy" class="slide level2">
<h2>Entropy</h2>
<p>The <strong>surprisal</strong> of a random event <span class="math inline">\(E\)</span> is defined to be equal to <span class="math display">\[
-\log_2(\mathbb{P}(E)),
\]</span> where <span class="math inline">\(\mathbb{P}(E)\)</span> is the probability that <span class="math inline">\(E\)</span> occurs.</p>
<p>So the less likely the event is to occur the bigger its surprisal.</p>
</section>
<section id="entropy-1" class="slide level2">
<h2>Entropy</h2>
<p>Suppose <span class="math inline">\(X\)</span> is a finite discrete random variable taking values <span class="math inline">\(x_1, \dots x_n.\)</span> The <strong>entropy</strong> of <span class="math inline">\(X\)</span> is then defined to be the expected value of surprisal, it is denoted <span class="math inline">\(H(X).\)</span> That is <span class="math display">\[
  H(X) = -\sum_{i=1}^n p(x_i)\log_2(p(x_i)),
\]</span> where <span class="math inline">\(p\)</span> is the probability mass function of <span class="math inline">\(X.\)</span></p>
</section>
<section id="entropy-2" class="slide level2">
<h2>Entropy</h2>
<p>Entropy is used to measure how uncertain the outcome of a random variable is. The higher the entropy the more uncertain.</p>
<p>For example, suppose you have a fair coin. Then the outcome of a coin toss is very uncertain, its as likely to go either way. The entropy in this case is <span class="math display">\[
  -\frac{1}{2}\log_2\left(\frac{1}{2}\right)-\frac{1}{2}\log_2\left(\frac{1}{2}\right)= 1.
\]</span> This is as large as entropy can be for a Bernoulli random variable.</p>
</section>
<section id="entropy-3" class="slide level2">
<h2>Entropy</h2>
<p>Now suppose you have a biased coin that lands on heads 90% of the time. The outcome of the coin toss is then very certain - its going to be heads most of the time. The entropy is also lower <span class="math display">\[
  -\frac{9}{10}\log_2\left(\frac{9}{10}\right)-\frac{1}{10}\log_2\left(\frac{1}{10}\right)\approx 0.47.
\]</span></p>
</section>
<section id="entropy-4" class="slide level2">
<h2>Entropy</h2>
<p>Lastly, suppose you have a coin that has heads on both sides. The coin toss has no uncertainty at all with such a coin! Its entropy is <span class="math inline">\(0\)</span>, indeed <span class="math display">\[
  -1\log_2\left(1\right)=0.
\]</span></p>
<p>We will use entropy when training decision trees.</p>
</section>
<section id="decision-trees" class="slide level2">
<h2>Decision Trees</h2>
<p>I’m sure you’ve all seen a decision tree before. They look something like this:</p>

<img data-src="../images/decision-tree.jpg" class="quarto-figure quarto-figure-center r-stretch"></section>
<section id="decision-trees-1" class="slide level2">
<h2>Decision Trees</h2>
<p>How to train a decision tree?</p>
<p>Suppose we are trying to solve a classification problem. That is we have some training data with features and a target variable with <span class="math inline">\(n\)</span> classes.</p>
<p>A decision tree is going to sort our training samples into groups, one group for each node. Then we can compute the entropy of each node. When we split a parent node into two nodes we want the split to minimize entropy as much as possible.</p>
</section>
<section id="decision-trees-2" class="slide level2">
<h2>Decision Trees</h2>
<p>Define information gain as <span class="math display">\[
  H(\text{parent}) - \left(\frac{N_{\text{left}}}{N_{\text{parent}}}H(\text{left})+\frac{N_{\text{right}}}{N_{\text{parent}}}H(\text{right})\right),
\]</span> where <span class="math inline">\(N_\text{parent}, N_{\text{left}}, N_{\text{right}}\)</span> denotes the number of samples in the respective node.</p>
<p>For each feature we compute the split that optimizes information gain and then choose the feature with the highest information gain to split on.</p>
</section>
<section id="decision-trees-3" class="slide level2">
<h2>Decision Trees</h2>
<p>We then do this procedure iteratively starting from the root node that contains all samples. This algorithm does not produce an optimal tree, but there is no known polynomial time algorithm that does, so it’ll have to do.</p>
<p>There are other measures you can use to compute information gain instead of entropy, such as <a href="https://en.wikipedia.org/wiki/Decision_tree_learning#Gini_impurity">Gini impurity</a>.</p>
</section>
<section id="decision-trees-4" class="slide level2">
<h2>Decision Trees</h2>
<p>We can train a decision tree using sklearn. We’ll use this <a href="https://archive.ics.uci.edu/dataset/17/breast+cancer+wisconsin+diagnostic">dataset</a>.</p>
<div id="a8ad0e42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href=""></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> load_breast_cancer</span>
<span id="cb1-2"><a href=""></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-3"><a href=""></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier</span>
<span id="cb1-4"><a href=""></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> classification_report</span>
<span id="cb1-5"><a href=""></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-6"><a href=""></a></span>
<span id="cb1-7"><a href=""></a>dataset <span class="op">=</span> load_breast_cancer()</span>
<span id="cb1-8"><a href=""></a>X <span class="op">=</span> pd.DataFrame(dataset.data, columns<span class="op">=</span>dataset.feature_names)</span>
<span id="cb1-9"><a href=""></a>y <span class="op">=</span> dataset.target_names[dataset.target]</span>
<span id="cb1-10"><a href=""></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, test_size<span class="op">=</span><span class="fl">0.3</span>, random_state<span class="op">=</span><span class="dv">34</span>)</span>
<span id="cb1-11"><a href=""></a></span>
<span id="cb1-12"><a href=""></a>model <span class="op">=</span> DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">3</span>, criterion<span class="op">=</span><span class="st">"entropy"</span>, random_state<span class="op">=</span><span class="dv">34</span>)</span>
<span id="cb1-13"><a href=""></a>model.fit(X_train, y_train)</span>
<span id="cb1-14"><a href=""></a>y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb1-15"><a href=""></a></span>
<span id="cb1-16"><a href=""></a><span class="bu">print</span>(classification_report(y_test, y_pred))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>

</section>
<section id="decision-trees-4-output" class="slide level2 output-location-slide"><h2>Decision Trees</h2><div class="cell output-location-slide" data-execution_count="1">
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

      benign       0.96      0.94      0.95       111
   malignant       0.89      0.93      0.91        60

    accuracy                           0.94       171
   macro avg       0.93      0.94      0.93       171
weighted avg       0.94      0.94      0.94       171
</code></pre>
</div>
</div></section><section id="overfitting" class="slide level2">
<h2>Overfitting</h2>
<p>The main problem with decision trees is that they tend to overfit.</p>
<p><strong>Overfitting</strong> is a phenomenon where a model learns the noise in the training set rather than the signal. It then is not able to generalize to the data outside the training set.</p>

<img data-src="../images/overfitting.svg" class="quarto-figure quarto-figure-center r-stretch"></section>
<section id="overfitting-1" class="slide level2">
<h2>Overfitting</h2>
<p>Let’s illustrate overfitting.</p>
<div id="d45de911" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href=""></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb3-2"><a href=""></a></span>
<span id="cb3-3"><a href=""></a>losses <span class="op">=</span> []</span>
<span id="cb3-4"><a href=""></a></span>
<span id="cb3-5"><a href=""></a><span class="cf">for</span> depth <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">10</span>):</span>
<span id="cb3-6"><a href=""></a>  model <span class="op">=</span> DecisionTreeClassifier(max_depth<span class="op">=</span>depth, criterion<span class="op">=</span><span class="st">"entropy"</span>, random_state<span class="op">=</span><span class="dv">34</span>)</span>
<span id="cb3-7"><a href=""></a>  model.fit(X_train, y_train)</span>
<span id="cb3-8"><a href=""></a>  losses.append([</span>
<span id="cb3-9"><a href=""></a>    accuracy_score(y_train, model.predict(X_train)),</span>
<span id="cb3-10"><a href=""></a>    accuracy_score(y_test, model.predict(X_test))</span>
<span id="cb3-11"><a href=""></a>  ])</span>
<span id="cb3-12"><a href=""></a></span>
<span id="cb3-13"><a href=""></a>pd.DataFrame(losses, columns<span class="op">=</span>[<span class="st">'train'</span>, <span class="st">'test'</span>]).plot(title<span class="op">=</span><span class="st">'Accuracy for different max_depth values'</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>

</section>
<section id="overfitting-1-output" class="slide level2 output-location-slide"><h2>Overfitting</h2><div class="cell output-location-slide" data-execution_count="2">
<div class="cell-output cell-output-display">
<div>
<figure>
<p><img data-src="02_decision_trees_and_random_forest_files/figure-revealjs/cell-3-output-1.png"></p>
</figure>
</div>
</div>
</div></section><section id="random-forest" class="slide level2">
<h2>Random Forest</h2>
<p>Different model types have different techniques for dealing with overfitting.</p>
<p>In case of decision trees, one approach is to train several decision trees on randomly selected subsets of the features and training data. Then these trees are polled to generate the final prediction. This modelling technique is called <strong>Random Forest</strong>.</p>
</section>
<section id="random-forest-1" class="slide level2">
<h2>Random Forest</h2>
<p>Decision Trees and Random Forest can also be used on regression problems. In a regression problem we are trying to predict a continuous variable given some inputs.</p>
<p>Let’s train a Random Forest Regression model on California housing dataset that ships with sklearn.</p>
<div id="261271dd" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href=""></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_california_housing</span>
<span id="cb4-2"><a href=""></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb4-3"><a href=""></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-4"><a href=""></a></span>
<span id="cb4-5"><a href=""></a>data <span class="op">=</span> fetch_california_housing()</span>
<span id="cb4-6"><a href=""></a>df <span class="op">=</span> pd.DataFrame(data[<span class="st">"data"</span>], columns<span class="op">=</span>data[<span class="st">"feature_names"</span>])</span>
<span id="cb4-7"><a href=""></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(df, data[<span class="st">"target"</span>], test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">34</span>)</span>
<span id="cb4-8"><a href=""></a>X_train.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>

</section>
<section id="random-forest-1-output" class="slide level2 output-location-slide"><h2>Random Forest</h2><div class="cell output-location-slide" data-execution_count="3">
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe caption-top" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MedInc</th>
<th data-quarto-table-cell-role="th">HouseAge</th>
<th data-quarto-table-cell-role="th">AveRooms</th>
<th data-quarto-table-cell-role="th">AveBedrms</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">AveOccup</th>
<th data-quarto-table-cell-role="th">Latitude</th>
<th data-quarto-table-cell-role="th">Longitude</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">7067</th>
<td>4.4318</td>
<td>36.0</td>
<td>5.721014</td>
<td>1.050725</td>
<td>816.0</td>
<td>2.956522</td>
<td>33.95</td>
<td>-118.01</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">18972</th>
<td>5.2636</td>
<td>1.0</td>
<td>7.694030</td>
<td>1.279851</td>
<td>872.0</td>
<td>3.253731</td>
<td>38.23</td>
<td>-122.00</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10877</th>
<td>3.9844</td>
<td>38.0</td>
<td>5.403042</td>
<td>1.140684</td>
<td>1236.0</td>
<td>4.699620</td>
<td>33.72</td>
<td>-117.88</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20440</th>
<td>6.4963</td>
<td>6.0</td>
<td>7.799038</td>
<td>1.110096</td>
<td>6700.0</td>
<td>3.221154</td>
<td>34.24</td>
<td>-118.77</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">15424</th>
<td>4.3542</td>
<td>34.0</td>
<td>5.578313</td>
<td>0.969880</td>
<td>978.0</td>
<td>2.945783</td>
<td>33.20</td>
<td>-117.27</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">20222</th>
<td>3.5294</td>
<td>33.0</td>
<td>4.310962</td>
<td>1.098434</td>
<td>1835.0</td>
<td>2.052573</td>
<td>34.29</td>
<td>-119.29</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">16512</th>
<td>2.6368</td>
<td>34.0</td>
<td>5.769022</td>
<td>1.051630</td>
<td>1310.0</td>
<td>3.559783</td>
<td>37.72</td>
<td>-121.22</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2622</th>
<td>1.8993</td>
<td>17.0</td>
<td>4.699367</td>
<td>1.091772</td>
<td>823.0</td>
<td>2.604430</td>
<td>40.95</td>
<td>-124.10</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6033</th>
<td>3.8438</td>
<td>28.0</td>
<td>5.422432</td>
<td>1.120545</td>
<td>3502.0</td>
<td>3.670860</td>
<td>34.08</td>
<td>-117.73</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3421</th>
<td>2.8000</td>
<td>34.0</td>
<td>4.553531</td>
<td>0.972665</td>
<td>2391.0</td>
<td>5.446469</td>
<td>34.28</td>
<td>-118.42</td>
</tr>
</tbody>
</table>

</div>
</div>
</div></section><section id="random-forest-2" class="slide level2">
<h2>Random Forest</h2>
<p>We are given some information on a district and our goal is to predict the median house value in that district. The target variable is expressed in $100k.</p>
<p>Normally, we would first do data exploration and cleaning, but since we talked about this in the last chapter, let’s jump straight into model code.</p>
</section>
<section id="random-forest-3" class="slide level2">
<h2>Random Forest</h2>
<div id="d26a7b57" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href=""></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb5-2"><a href=""></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb5-3"><a href=""></a><span class="im">from</span> sklearn.impute <span class="im">import</span> SimpleImputer</span>
<span id="cb5-4"><a href=""></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb5-5"><a href=""></a></span>
<span id="cb5-6"><a href=""></a><span class="kw">def</span> make_pipeline():</span>
<span id="cb5-7"><a href=""></a>  model <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb5-8"><a href=""></a>    n_estimators<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb5-9"><a href=""></a>    max_depth<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb5-10"><a href=""></a>    max_features<span class="op">=</span><span class="st">"sqrt"</span></span>
<span id="cb5-11"><a href=""></a>  )</span>
<span id="cb5-12"><a href=""></a></span>
<span id="cb5-13"><a href=""></a>  pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb5-14"><a href=""></a>    steps<span class="op">=</span>[</span>
<span id="cb5-15"><a href=""></a>      (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb5-16"><a href=""></a>      (<span class="st">"scaler"</span>, StandardScaler()),</span>
<span id="cb5-17"><a href=""></a>      (<span class="st">"model"</span>, model),</span>
<span id="cb5-18"><a href=""></a>    ],</span>
<span id="cb5-19"><a href=""></a>  )</span>
<span id="cb5-20"><a href=""></a></span>
<span id="cb5-21"><a href=""></a>  <span class="cf">return</span> pipeline</span>
<span id="cb5-22"><a href=""></a></span>
<span id="cb5-23"><a href=""></a>pipeline <span class="op">=</span> make_pipeline()</span>
<span id="cb5-24"><a href=""></a>pipeline</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>

</section>
<section id="random-forest-3-output" class="slide level2 output-location-slide"><h2>Random Forest</h2><div class="cell output-location-slide" data-execution_count="4">
<div class="cell-output cell-output-display" data-execution_count="4">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[('imputer', SimpleImputer(strategy='median')),
                ('scaler', StandardScaler()),
                ('model',
                 RandomForestRegressor(max_depth=3, max_features='sqrt'))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden=""><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox"><label for="sk-estimator-id-1" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>Pipeline</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link ">i<span>Not fitted</span></span></div></label><div class="sk-toggleable__content "><pre>Pipeline(steps=[('imputer', SimpleImputer(strategy='median')),
                ('scaler', StandardScaler()),
                ('model',
                 RandomForestRegressor(max_depth=3, max_features='sqrt'))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox"><label for="sk-estimator-id-2" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>SimpleImputer</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.impute.SimpleImputer.html">?<span>Documentation for SimpleImputer</span></a></div></label><div class="sk-toggleable__content "><pre>SimpleImputer(strategy='median')</pre></div> </div></div><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox"><label for="sk-estimator-id-3" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>StandardScaler</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.preprocessing.StandardScaler.html">?<span>Documentation for StandardScaler</span></a></div></label><div class="sk-toggleable__content "><pre>StandardScaler()</pre></div> </div></div><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox"><label for="sk-estimator-id-4" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>RandomForestRegressor</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.ensemble.RandomForestRegressor.html">?<span>Documentation for RandomForestRegressor</span></a></div></label><div class="sk-toggleable__content "><pre>RandomForestRegressor(max_depth=3, max_features='sqrt')</pre></div> </div></div></div></div></div></div>
</div>
</div></section><section id="random-forest-4" class="slide level2">
<h2>Random Forest</h2>
<p>We are going to use mean square error (MSE) to evaluate our model. It is computed as follows: <span class="math display">\[
\text{MSE} = \frac{1}{n} \sum_{i=1}^n (y_i^{\text{true}}-y_i^{\text{pred}})^2
\]</span></p>
<div id="afd32a5b" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href=""></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb6-2"><a href=""></a></span>
<span id="cb6-3"><a href=""></a>pipeline.fit(X_train, y_train)</span>
<span id="cb6-4"><a href=""></a>y_pred <span class="op">=</span> pipeline.predict(X_test)</span>
<span id="cb6-5"><a href=""></a><span class="bu">print</span>(<span class="ss">f"MSE on train set: </span><span class="sc">{</span>mean_squared_error(y_test, y_pred)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSE on train set: 0.6841335525164595</code></pre>
</div>
</div>
</section>
<section id="hyperparameters" class="slide level2">
<h2>Hyperparameters</h2>
<p>As you might have noticed, in the <code>RandomForestRegressor</code> we specified some parameters:</p>
<ul>
<li><code>n_estimators</code>: number of trees to fit;</li>
<li><code>max_depth</code>: maximum depth of a fitted tree.</li>
</ul>
<p>There are more, you can see all of the in the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">documentation</a>.</p>
</section>
<section id="hyperparameters-1" class="slide level2">
<h2>Hyperparameters</h2>
<p>These are called model <strong>hyperparameters</strong>. A hyperparameter is a model parameter that the model does not learn while training. These are left for the model user to specify.</p>
<p>So we have a classification:</p>
<ol type="1">
<li>Weights: parameters that the model learns while training.</li>
<li>Hyperparameters: parameters that the model does not learn while training.</li>
</ol>
</section>
<section id="hyperparameters-2" class="slide level2">
<h2>Hyperparameters</h2>
<p>Question is, how do we pick optimal hyperparameters?</p>
<p>Usually, it is done through trial and error by trying different combinations of reasonable values and seeing which perform best on the test dataset. This is called <strong>grid search</strong>.</p>
</section>
<section id="grid-search" class="slide level2">
<h2>Grid Search</h2>
<p>To implement a grid search we first need to unhardcode the hyperparameters in our pipeline.</p>
<div id="79f79662" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href=""></a><span class="kw">def</span> make_pipeline(n_estimators<span class="op">=</span><span class="dv">100</span>, max_depth<span class="op">=</span><span class="dv">3</span>):</span>
<span id="cb8-2"><a href=""></a>  model <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb8-3"><a href=""></a>    n_estimators<span class="op">=</span>n_estimators,</span>
<span id="cb8-4"><a href=""></a>    max_depth<span class="op">=</span>max_depth,</span>
<span id="cb8-5"><a href=""></a>    max_features<span class="op">=</span><span class="st">"sqrt"</span>,</span>
<span id="cb8-6"><a href=""></a>    n_jobs<span class="op">=-</span><span class="dv">1</span> <span class="co"># Use max available processors for training and inference</span></span>
<span id="cb8-7"><a href=""></a>  )</span>
<span id="cb8-8"><a href=""></a></span>
<span id="cb8-9"><a href=""></a>  pipeline <span class="op">=</span> Pipeline(</span>
<span id="cb8-10"><a href=""></a>    steps<span class="op">=</span>[</span>
<span id="cb8-11"><a href=""></a>      (<span class="st">"imputer"</span>, SimpleImputer(strategy<span class="op">=</span><span class="st">"median"</span>)),</span>
<span id="cb8-12"><a href=""></a>      (<span class="st">"scaler"</span>, StandardScaler()),</span>
<span id="cb8-13"><a href=""></a>      (<span class="st">"model"</span>, model),</span>
<span id="cb8-14"><a href=""></a>    ],</span>
<span id="cb8-15"><a href=""></a>  )</span>
<span id="cb8-16"><a href=""></a></span>
<span id="cb8-17"><a href=""></a>  <span class="cf">return</span> pipeline</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="grid-search-1" class="slide level2">
<h2>Grid Search</h2>
<p>Now implementing a grid search from scratch is not difficult.</p>
<div id="951b5357" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href=""></a>best_n_estimators <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb9-2"><a href=""></a>best_max_depth <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb9-3"><a href=""></a>best_mse <span class="op">=</span> <span class="dv">1000</span></span>
<span id="cb9-4"><a href=""></a></span>
<span id="cb9-5"><a href=""></a><span class="cf">for</span> n_estimators <span class="kw">in</span> [<span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">500</span>]:</span>
<span id="cb9-6"><a href=""></a>  <span class="cf">for</span> max_depth <span class="kw">in</span> [<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]:</span>
<span id="cb9-7"><a href=""></a>    pipeline <span class="op">=</span> make_pipeline(n_estimators<span class="op">=</span>n_estimators, max_depth<span class="op">=</span>max_depth)</span>
<span id="cb9-8"><a href=""></a>    pipeline.fit(X_train, y_train)</span>
<span id="cb9-9"><a href=""></a>    y_pred <span class="op">=</span> pipeline.predict(X_test)</span>
<span id="cb9-10"><a href=""></a>    mse <span class="op">=</span> mean_squared_error(y_test, y_pred)</span>
<span id="cb9-11"><a href=""></a>    <span class="cf">if</span> mse <span class="op">&lt;</span> best_mse:</span>
<span id="cb9-12"><a href=""></a>      best_mse <span class="op">=</span> mse</span>
<span id="cb9-13"><a href=""></a>      best_n_estimators <span class="op">=</span> n_estimators</span>
<span id="cb9-14"><a href=""></a>      best_max_depth <span class="op">=</span> max_depth</span>
<span id="cb9-15"><a href=""></a></span>
<span id="cb9-16"><a href=""></a><span class="bu">print</span>(<span class="ss">f"Best combination n_estimators=</span><span class="sc">{</span>best_n_estimators<span class="sc">}</span><span class="ss">, max_depth=</span><span class="sc">{</span>best_max_depth<span class="sc">}</span><span class="ss"> with MSE=</span><span class="sc">{</span>best_mse<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best combination n_estimators=500, max_depth=5 with MSE=0.4958425838126335</code></pre>
</div>
</div>
</section>
<section id="validation" class="slide level2">
<h2>Validation</h2>
<p>Now that we used our test set to optimize hyperparameters we cannot use it to judge model performance, because we might have “overfit” the hyperparameters.</p>
<p>This is why usually you should split your data into three parts: train, validation and test:</p>
<ul>
<li>train: the set that you use to train the model;</li>
<li>validation: the set that you use to tune the model, for example by doing grid search as we did;</li>
<li>test: the set that you use only once at the end of the modelling process to evaluate the model.</li>
</ul>
</section>
<section id="validation-1" class="slide level2">
<h2>Validation</h2>
<p>Note that its not set in stone which of the datasets are called validation and test. That is some people might switch the definitions around.</p>
</section>
<section id="extras" class="slide level2">
<h2>Extras</h2>
<p>There are many variations on the basic Random Forest idea. Here are some examples:</p>
<ul>
<li><a href="https://scikit-learn.org/stable/modules/ensemble.html#extremely-randomized-trees">ExtraTrees</a></li>
<li><a href="https://xgboost.readthedocs.io/en/latest/">XGBoost</a></li>
<li><a href="https://lightgbm.readthedocs.io/en/latest/">LightGBM</a></li>
</ul>
</section>
<section id="practice-problem" class="slide level2">
<h2>Practice problem</h2>
<p>For practice, try creating a classification model for the <a href="https://www.kaggle.com/datasets/uciml/forest-cover-type-dataset">Forest cover types dataset</a>. It ships with sklearn.</p>
<p>If you want to use Random Forest, you will need to use the <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html#sklearn.ensemble.RandomForestClassifier">RandomForestClassifier</a> class from sklearn.</p>
<p>Here is how to load the data:</p>
<div id="d368cce8" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href=""></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> fetch_covtype</span>
<span id="cb11-2"><a href=""></a></span>
<span id="cb11-3"><a href=""></a>data <span class="op">=</span> fetch_covtype()</span>
<span id="cb11-4"><a href=""></a>df <span class="op">=</span> pd.DataFrame(data[<span class="st">"data"</span>], columns<span class="op">=</span>data[<span class="st">"feature_names"</span>])</span>
<span id="cb11-5"><a href=""></a>df[<span class="st">"target"</span>] <span class="op">=</span> data[<span class="st">"target"</span>]</span>
<span id="cb11-6"><a href=""></a>df.head(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>
<style scoped="">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>

<table class="dataframe caption-top" data-border="1">
<thead>
<tr class="header" style="text-align: right;">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Elevation</th>
<th data-quarto-table-cell-role="th">Aspect</th>
<th data-quarto-table-cell-role="th">Slope</th>
<th data-quarto-table-cell-role="th">Horizontal_Distance_To_Hydrology</th>
<th data-quarto-table-cell-role="th">Vertical_Distance_To_Hydrology</th>
<th data-quarto-table-cell-role="th">Horizontal_Distance_To_Roadways</th>
<th data-quarto-table-cell-role="th">Hillshade_9am</th>
<th data-quarto-table-cell-role="th">Hillshade_Noon</th>
<th data-quarto-table-cell-role="th">Hillshade_3pm</th>
<th data-quarto-table-cell-role="th">Horizontal_Distance_To_Fire_Points</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">Soil_Type_31</th>
<th data-quarto-table-cell-role="th">Soil_Type_32</th>
<th data-quarto-table-cell-role="th">Soil_Type_33</th>
<th data-quarto-table-cell-role="th">Soil_Type_34</th>
<th data-quarto-table-cell-role="th">Soil_Type_35</th>
<th data-quarto-table-cell-role="th">Soil_Type_36</th>
<th data-quarto-table-cell-role="th">Soil_Type_37</th>
<th data-quarto-table-cell-role="th">Soil_Type_38</th>
<th data-quarto-table-cell-role="th">Soil_Type_39</th>
<th data-quarto-table-cell-role="th">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2596.0</td>
<td>51.0</td>
<td>3.0</td>
<td>258.0</td>
<td>0.0</td>
<td>510.0</td>
<td>221.0</td>
<td>232.0</td>
<td>148.0</td>
<td>6279.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>5</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2590.0</td>
<td>56.0</td>
<td>2.0</td>
<td>212.0</td>
<td>-6.0</td>
<td>390.0</td>
<td>220.0</td>
<td>235.0</td>
<td>151.0</td>
<td>6225.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>5</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2804.0</td>
<td>139.0</td>
<td>9.0</td>
<td>268.0</td>
<td>65.0</td>
<td>3180.0</td>
<td>234.0</td>
<td>238.0</td>
<td>135.0</td>
<td>6121.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>2</td>
</tr>
</tbody>
</table>

<p>3 rows × 55 columns</p>
</div>
</div>
</div>

</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<div class="footer footer-default">

</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/notes/notes.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/search/search.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="02_decision_trees_and_random_forest_files/libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
          const outerScaffold = trigger.parentElement.cloneNode(true);
          const codeEl = outerScaffold.querySelector('code');
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp('/' + window.location.host + '/');
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>